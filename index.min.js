(function(global,factory){if(typeof define==="function"&&define.amd){define("CGFrameStorageProxy",["exports"],factory)}else if(typeof exports!=="undefined"){factory(exports)}else{var mod={exports:{}};factory(mod.exports);global.CGFrameStorageProxy=mod.exports}})(typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:this,function(_exports){"use strict";Object.defineProperty(_exports,"__esModule",{value:true});_exports.frameProxyInit=P;_exports.registerParentProxy=R;var $="iframeStorageProxy:",I="__iframe__",S="__frame-storage-proxy__store";function E(o){var c={},n;if(o&&typeof o.persist=="function"&&(n=o.persist),o&&typeof o.hydrate=="function")try{var e=o.hydrate();for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(c[r]=e[r])}catch(e){console.error("Hydration failed:",e)}this.getItem=function(e){return Object.prototype.hasOwnProperty.call(c,e)?c[e]:null},this.setItem=function(e,r){c[e]=r,a("setItem",e,r)},this.removeItem=function(e){delete c[e],a("removeItem",e)},this.clear=function(){c={},a("clear")},this.key=function(e){var r=Object.keys(c);return r.length>e?r[e]:null},Object.defineProperty(this,"length",{get:function get(){return Object.keys(c).length},enumerable:!0,configurable:!0});function a(e,r,t){try{typeof n=="function"&&n(c,e,r,t)}catch(s){console.error("Persist failed:",s)}}}var j=E;function O(){var o=arguments.length>0&&arguments[0]!==undefined?arguments[0]:sessionStorage;var c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!1;return new j({hydrate:function hydrate(){if(c)try{var n=o.getItem(S);return n?JSON.parse(n):{}}catch(n){return console.error("Failed to hydrate from storage",n),{}}else{var _n={};for(var a=0;a<o.length;a++){var e=o.key(a);if(e!=null&&e.startsWith(I)){var r=e.slice(I.length);try{_n[r]=o.getItem(e)}catch(t){console.warn("Failed to parse key \"".concat(e,"\""),t)}}}return _n}},persist:function persist(n,a,e,r){if(c)try{o.setItem(S,JSON.stringify(n))}catch(t){console.error("Failed to persist to storage",t)}else try{switch(a){case"setItem":o.setItem("".concat(I).concat(e),r);break;case"removeItem":o.removeItem("".concat(I).concat(e));break;case"clear":for(var t=o.length-1;t>=0;t--){var s=o.key(t);s!=null&&s.startsWith(I)&&o.removeItem(s)}break}}catch(t){console.error("Failed to persist with event \"".concat(a,"\""),t)}}})}function P(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$storageType=_ref.storageType,o=_ref$storageType===void 0?"localStorage":_ref$storageType,_ref$disabled=_ref.disabled,c=_ref$disabled===void 0?function(){return!1}:_ref$disabled,_ref$eventPrefix=_ref.eventPrefix,n=_ref$eventPrefix===void 0?$:_ref$eventPrefix,_ref$sendMessage=_ref.sendMessage,a=_ref$sendMessage===void 0?function(r){window.parent.postMessage(Object.assign({type:r.type},r.payload),"*")}:_ref$sendMessage,_ref$registerMessage=_ref.registerMessage,e=_ref$registerMessage===void 0?function(r){var t=function t(s){r(s)};return window.addEventListener("message",t),function(){window.removeEventListener("message",t)}}:_ref$registerMessage;if(c())return{isReady:!0};var r=window[o],t=O(),s="".concat(n,"ready"),f=t.getItem(s)==="1",u={},d={},g=e(function(i){var _i$data=i.data,h=_i$data.type,l=_i$data.chunk,y=_i$data.chunkIndex,b=_i$data.chunkTotal,m=_i$data.chunkId;if(h==="".concat(n,"initResultChunk")){if(!m||typeof y!="number")return;if(u[m]||(u[m]=[],d[m]={total:b,count:0}),console.log("IframeStorageProxy:".concat(n,"initResultChunk response"),y),u[m][y]=l,d[m].count++,d[m].count===b){var _=u[m].join("");try{var p=JSON.parse(_);for(var w in p)Object.prototype.hasOwnProperty.call(p,w)&&t.setItem(w,p[w]);delete u[m],delete d[m],t.setItem(s,"1"),location.reload()}catch(p){console.error(p)}console.log("IframeStorageProxy:".concat(n,"initResultChunk done"),Date.now()),g()}}});f||(console.log("IframeStorageProxy:".concat(n,"init send"),Date.now()),a({type:"".concat(n,"init")}));var k={getItem:function getItem(i){return t.getItem(i)},setItem:function setItem(i,h){r.setItem(i,h),t.setItem(i,h),a({type:"".concat(n,"setItem"),payload:{key:i,value:h}})},removeItem:function removeItem(i){r.removeItem(i),t.removeItem(i),a({type:"".concat(n,"removeItem"),payload:{key:i}})},clear:function clear(){r.clear(),t.clear(),a({type:"".concat(n,"clear")})},key:function key(i){return t.key(i)},get length(){return t.length}};return Object.defineProperty(window,o,{configurable:!0,enumerable:!0,get:function get(){return k}}),{isReady:f}}function R(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref2$storage=_ref2.storage,o=_ref2$storage===void 0?O(localStorage):_ref2$storage,_ref2$eventPrefix=_ref2.eventPrefix,c=_ref2$eventPrefix===void 0?$:_ref2$eventPrefix,_ref2$chunkSize=_ref2.chunkSize,n=_ref2$chunkSize===void 0?100*1024:_ref2$chunkSize,_ref2$sendMessage=_ref2.sendMessage,a=_ref2$sendMessage===void 0?function(r,t,s){t&&t.postMessage(Object.assign({type:r.type},r.payload),s||"*")}:_ref2$sendMessage,_ref2$registerMessage=_ref2.registerMessage,e=_ref2$registerMessage===void 0?function(r){window.addEventListener("message",r)}:_ref2$registerMessage;return e(function(t){var _t$data=t.data,s=_t$data.type,f=_t$data.key,u=_t$data.value;if(typeof s!="string"||!s.startsWith(c))return;switch(s.slice(c.length)){case"init":{console.log("IframeStorageProxy: listener message in parent",Date.now());var g={};for(var l=0;l<o.length;l++){var y=o.key(l);g[y]=o.getItem(y)}var k=JSON.stringify(g),i=Math.ceil(k.length/n),h="chunk_".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2));for(var _l=0;_l<i;_l++){var _y=k.slice(_l*n,(_l+1)*n);a({type:"".concat(c,"initResultChunk"),payload:{chunk:_y,chunkIndex:_l,chunkTotal:i,chunkId:h}},t.source,t.origin)}break}case"setItem":o.setItem(f,u);break;case"removeItem":o.removeItem(f);break;case"clear":o.clear();break}}),{clearProxyStorage:function clearProxyStorage(){o.clear()}}}});
